# ADR-0004: 叙事-数据双视图对照设计

**Status**: Proposed
**Date**: 2026-02-16
**Deciders**: Product & Architecture Team

## Context

AI School 仿真平台在运行过程中同时产生两种本质不同的信息表征：

1. **叙事层（文字）**：LLM 产生的自然语言描述 — 记录了事件的"故事"
2. **仿真层（数据）**：结构化的状态变化 — 记录了事件的"量化影响"

### 核心问题

> 是否需要一个文字与仿真的对照？

这个问题实质上是：研究者在观察仿真结果时，**仅看数据**或**仅看叙事**是否足够？

### 示例：同一事件的两种表征

| 时刻 | 叙事层 | 仿真层 |
|------|--------|--------|
| 09:00 | "小明进入数学课堂，注意到小红坐在隔壁" | `小明.位置=教室A, 观察事件=[小红在旁]` |
| 09:30 | "老师布置分组课题，小明和小红被分到一组" | `事件=分组任务, 组=[小明,小红], 小明.压力+=0.1` |
| 10:00 | "两人因方案分歧争执，小明觉得自己的逻辑更合理但没被采纳" | `冲突事件, 关系亲密度-=0.2, 小明.MBTI.T维+=0.01, 小明.情绪=-0.3` |

仅看叙事：知道发生了什么，但不知道量化影响多大
仅看数据：知道数值变了，但不知道为什么变

### 研究依据

Generative Agents 研究中识别的反馈回路 R3（噪声自我放大）提供了对照机制的额外动机：

> 记忆噪声→幻觉/错误行为→错误记忆被引用→产生更多错误（正反馈回路 R3）

如果叙事层和仿真层的数据可以对照检查，不一致之处就能被及时发现，作为 R3 的**断路器**。

## Decision Drivers

- **研究完整性**：理解"为什么"（叙事）和"影响多大"（数据）都是研究所需
- **可解释性**：研究者需要能解释仿真结果，纯数据缺乏故事，纯叙事缺乏依据
- **一致性检测**：需要能发现 LLM 叙事与实际状态变更之间的不一致（幻觉检测）
- **调试支持**：开发和调参过程中，对照视图是最有效的调试工具

## Considered Options

### Option 1: 仅数据视图

只展示结构化数据的变化图表和统计。

- **Pros**: 实现简单，纯数据分析
- **Cons**: 无法理解因果关系，研究者难以解释结果

### Option 2: 仅叙事视图

只展示 LLM 生成的事件叙事文本。

- **Pros**: 直观易读，沉浸感强
- **Cons**: 无法量化分析，无法发现幻觉，不支持统计研究

### Option 3: 叙事-数据双视图对照（推荐）

同时展示叙事和数据，支持联动和一致性检测。

- **Pros**: 研究完整性最高，支持幻觉检测，兼顾理解与分析
- **Cons**: 前端实现复杂度较高，需要叙事与数据的对齐机制

## Decision

采用 **Option 3：叙事-数据双视图对照**，作为 M5.1 发展轨迹可视化的核心设计原则。

### 双面板布局

```
┌─────────────────────────────────────────────────────────────┐
│  [时间轴控制栏]  ◀◀  ◀  ▶  ▶▶  │  速度: 1x  │  跳转: ___  │
├────────────────────────────┬────────────────────────────────┤
│                            │                                │
│     📖 叙事视图             │     📊 数据视图                 │
│                            │                                │
│  [09:00] 小明进入数学课堂， │  小明                          │
│  注意到小红坐在隔壁。他    │  ├ 位置: 教室A                 │
│  内心有些紧张，上次的合作  │  ├ 情绪: 0.2 (轻微紧张)       │
│  经历让他对分组任务有些    │  ├ 注意力: 0.7                 │
│  抵触...                   │  └ 观察: [小红在旁]            │
│                            │                                │
│  [09:30] 老师宣布分组课题，│  事件: 分组任务                │
│  小明和小红被分到一组。    │  ├ 类型: 学术协作              │
│  小明深吸一口气，决定这次  │  ├ 参与者: [小明, 小红]        │
│  要按自己的方案来...       │  └ 小明.压力: +0.1 → 0.5      │
│                            │                                │
│  [10:00] 两人因方案分歧    │  冲突事件                      │
│  发生争执。小明觉得自己的  │  ├ 强度: 0.6                   │
│  逻辑分析更合理，但小红    │  ├ 关系亲密度: -0.2 → 0.2     │
│  认为方案应该更考虑用户    │  ├ 小明.情绪: -0.3 → -0.1     │
│  感受。两人各执己见...     │  ├ 小红.情绪: -0.3 → -0.2     │
│                            │  └ 小明.MBTI.T: +0.01 → 0.72  │
│  ⚠️ [一致性提醒]           │                                │
│  叙事提到"小明深感沮丧"   │  ⚠️ 小明.情绪=-0.1 (轻度负面)  │
│  但数据显示情绪仅轻度负面  │  不匹配: 叙事夸大了情绪程度     │
│                            │                                │
├────────────────────────────┴────────────────────────────────┤
│  [底部] 关系图谱 │ 人格雷达图 │ 情绪曲线 │ 事件时间线       │
└─────────────────────────────────────────────────────────────┘
```

### 三个核心设计原则

#### 原则一：时间对齐

叙事事件和数据变更通过时间戳精确对齐。点击叙事中的任何事件，数据面板联动高亮对应的状态变更；反之亦然。

```
事件记录 = {
    timestamp: "2026-09-15T09:30:00",
    narrative: "老师宣布分组课题，小明和小红被分到一组...",
    state_changes: [
        { target: "小明.压力", delta: +0.1, before: 0.4, after: 0.5 },
        { target: "group_assignment", value: ["小明", "小红"] }
    ],
    source_agent: "game_master",
    trigger: "curriculum_schedule"
}
```

#### 原则二：一致性检测

系统自动检测叙事描述与数据变更之间的不一致，标记为⚠️提醒：

| 检测类型 | 示例 | 作用 |
|---------|------|------|
| **情感强度不匹配** | 叙事说"极度愤怒"但情绪值仅 -0.2 | 发现 LLM 叙事夸大 |
| **因果缺失** | 数据显示关系骤变但叙事无对应事件 | 发现状态更新遗漏叙事 |
| **时间矛盾** | 叙事说"下午"但时间戳显示上午 | 发现 LLM 时间幻觉 |
| **角色混淆** | 叙事将行为归因于错误的 Agent | 发现 LLM 角色幻觉 |

这个一致性检测机制直接作为 R3（噪声自我放大回路）的**断路器**：当检测到不一致时，可以阻止错误记忆写入 M4.1，或标记该记忆的可信度。

#### 原则三：多粒度切换

支持不同研究场景的观察粒度：

| 粒度 | 叙事视图 | 数据视图 | 适用场景 |
|------|---------|---------|---------|
| **微观** | 逐句对话 | 每次状态变更 | 调试、深度案例分析 |
| **日视图** | 日记摘要 | 日度统计 | 日常观察 |
| **学期视图** | 学期总结 | 趋势图表 | 长期发展追踪 |
| **全程视图** | 关键转折点叙事 | 人格/能力演变曲线 | 研究结论 |

## Rationale

1. **叙事提供"为什么"，数据提供"多少"**— 两者缺一不可，尤其对于目标是"研究规律"的平台
2. **一致性检测是系统自我纠错的关键机制**— 直接对抗 R3 噪声放大回路
3. **ADR-0003 的架构天然支持双视图**— Game Master 输出同时包含 narrative 和 state_changes，无需额外转换
4. **多粒度切换**支持从开发调试到学术研究的全生命周期使用

## Consequences

### Positive

- 研究者同时获得定性理解和定量分析能力
- 一致性检测成为系统级的幻觉防护机制
- 双视图对照极大提升调试效率（开发阶段价值尤其显著）
- 与 ADR-0003 的 Game Master 输出格式天然对接

### Negative

- 前端开发工作量约增加 40-60%（相比单一视图）
- 一致性检测本身可能需要额外的 LLM 调用（或基于规则的启发式方法）
- 叙事生成质量直接影响叙事视图的价值

### Risks

- **叙事生成成本**：为每个事件生成高质量叙事可能增加显著的 LLM 调用成本
  - 缓解：叙事可按需生成（用户点击时才生成），或仅为关键事件生成
- **一致性检测误报**：可能产生过多不一致警告，导致告警疲劳
  - 缓解：设置阈值，仅报告显著不一致

## Implementation Notes

- M5.1 可视化应基于 Web 技术构建（React + D3.js 或类似方案），支持实时更新
- 事件记录的 schema 应统一包含 `narrative` 和 `state_changes` 两个字段（对齐 ADR-0003 的 GM 输出格式）
- 一致性检测建议先用规则引擎实现（成本低、可控），后续可引入轻量级 LLM 判断
- 多粒度切换的叙事摘要（日/学期/全程）可在仿真完成后批量生成，无需实时

## Related Decisions

- [ADR-0001](0001-system-architecture-overview.md): 整体架构（M5.1 的定位）
- [ADR-0003](0003-world-system-llm-interaction.md): Game Master 输出格式（双视图的数据源）
- 待决 D7: 前端形态（Web 可视化 vs 纯数据分析 vs 游戏化界面）

## References

- Generative Agents (Park et al., 2023) — 反馈回路 R3 的识别
- 研究综合文档 第七章 — 系统思维：反馈回路与杠杆点
- Concordia (Google DeepMind, 2023) — GM 输出格式的启发
